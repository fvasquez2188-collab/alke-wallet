<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet | Enviar Dinero</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style_propio.css">
</head>

<body>
<main class="container py-4 page-center">
  <section class="row justify-content-center w-100">
    <section class="col-12 col-md-8">

      <section class="card shadow">
        <section class="card-body">

          <h2 class="text-center mb-3">Enviar dinero</h2>

          <section class="text-center text-muted mb-3">
            Saldo disponible:
            <strong id="saldoActual">$0</strong>
          </section>

          <section class="mb-2">
            <input type="text" id="searchInput" class="form-control"
                   placeholder="Buscar contacto...">
          </section>

          <button id="btnAddContact" class="btn btn-outline-primary w-100 mb-3">
            ➕ Agregar contacto
          </button>

          <section>
            <ul id="contactList" class="list-group mb-3"></ul>
          </section>

          <section class="mb-3">
            <input type="number" id="amount" class="form-control"
                   placeholder="Monto a enviar">
          </section>

          <button id="transferBtn" class="btn btn-primary w-100 d-none">
            Enviar dinero
          </button>

          <section id="transferResult" class="text-center mt-3"></section>

          <button id="btnVolver" class="btn btn-outline-secondary w-100 mt-2">
            Volver al menú
          </button>

        </section>
      </section>

    </section>
  </section>
</main>


<!-- MODAL CONFIRMACIÓN -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmación</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center" id="confirmMessage"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="confirmActionBtn">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL AGREGAR CONTACTO -->
<div class="modal fade" id="addContactModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar contacto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="cName" class="form-control mb-2" placeholder="Nombre">
        <input id="cAlias" class="form-control mb-2" placeholder="Alias">
        <input id="cBank" class="form-control mb-2" placeholder="Banco">
        <input id="cAccount" class="form-control" placeholder="Cuenta">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" id="saveContactBtn">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===============================
   CONTACTOS (CON PERSISTENCIA)
=============================== */
const defaultContacts = [
  { name: "Juan Pérez", alias: "Juancho", bank: "BancoEstado", account: "12345678" },
  { name: "María González", alias: "Mari", bank: "Banco de Chile", account: "87654321" }
];

let contacts = [];

try {
  contacts = JSON.parse(localStorage.getItem("contacts")) || defaultContacts;
} catch {
  contacts = defaultContacts;
}

function guardarContactos() {
  try {
    localStorage.setItem("contacts", JSON.stringify(contacts));
  } catch {}
}

let selectedContact = null;

/* ===============================
   ELEMENTOS
=============================== */
const contactList = document.getElementById("contactList");
const searchInput = document.getElementById("searchInput");
const transferBtn = document.getElementById("transferBtn");
const amountInput = document.getElementById("amount");
const saldoTxt = document.getElementById("saldoActual");
const resultBox = document.getElementById("transferResult");

/* ===============================
   SALDO
=============================== */
let saldo = Number(localStorage.getItem("saldo")) || 0;
saldoTxt.textContent = `$${saldo.toLocaleString()}`;

/* ===============================
   MODAL CONFIRMACIÓN
=============================== */
const confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));
let accionConfirmada = null;

function mostrarConfirmacion(msg, accion) {
  document.getElementById("confirmMessage").textContent = msg;
  accionConfirmada = accion;
  confirmModal.show();
}

document.getElementById("confirmActionBtn").onclick = () => {
  confirmModal.hide();
  if (accionConfirmada) accionConfirmada();
};

/* ===============================
   RENDER CONTACTOS
=============================== */
function renderContacts() {
  const search = searchInput.value.toLowerCase();
  contactList.innerHTML = "";
  selectedContact = null;
  transferBtn.classList.add("d-none");

  contacts.filter(c =>
    c.name.toLowerCase().includes(search) ||
    c.alias.toLowerCase().includes(search) ||
    c.bank.toLowerCase().includes(search)
  ).forEach(c => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.innerHTML = `<strong>${c.name}</strong><br>${c.alias} | ${c.bank}`;
    li.onclick = () => {
      document.querySelectorAll("#contactList li").forEach(i => i.classList.remove("active"));
      li.classList.add("active");
      selectedContact = c;
      transferBtn.classList.remove("d-none");
    };
    contactList.appendChild(li);
  });
}

/* ===============================
   EVENTOS
=============================== */
searchInput.oninput = renderContacts;

document.getElementById("btnAddContact").onclick = () =>
  new bootstrap.Modal(document.getElementById("addContactModal")).show();

document.getElementById("saveContactBtn").onclick = () => {
  const c = {
    name: cName.value,
    alias: cAlias.value,
    bank: cBank.value,
    account: cAccount.value
  };

  if (!c.name || !c.alias || !c.bank || !c.account) return;

  contacts.push(c);
  guardarContactos();   // ✅ ahora persiste

  document.getElementById("addContactModal").querySelector("form")?.reset();
  bootstrap.Modal.getInstance(
    document.getElementById("addContactModal")
  ).hide();

  renderContacts();
};

transferBtn.onclick = () => {
  const monto = Number(amountInput.value);
  if (!selectedContact || monto <= 0 || monto > saldo) return;

  mostrarConfirmacion(
    `¿Enviar $${monto.toLocaleString()} a ${selectedContact.name}?`,
    () => {
      saldo -= monto;
      localStorage.setItem("saldo", saldo);
      guardarMovimiento(`Transferencia a ${selectedContact.name}`, monto);

      resultBox.innerHTML = `
        <div class="alert alert-success">
          Transferencia realizada con éxito.<br>
          Redirigiendo al menú...
        </div>
      `;

      setTimeout(() => {
        window.location.href = "menu1.html";
      }, 2000);
    }
  );
};

document.getElementById("btnVolver").onclick = () =>
  mostrarConfirmacion(
    "¿Deseas volver al menú principal?",
    () => window.location.href = "menu1.html"
  );

/* ===============================
   MOVIMIENTOS
=============================== */
function guardarMovimiento(desc, monto) {
  let t = JSON.parse(localStorage.getItem("transactions")) || [];
  t.unshift({ desc, monto, fecha: new Date().toLocaleString() });
  localStorage.setItem("transactions", JSON.stringify(t));
}

document.addEventListener("DOMContentLoaded", renderContacts);
</script>
</body>
</html>



